---
title: "Effector Analysis with paneffectR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Effector Analysis with paneffectR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

This vignette demonstrates how to use paneffectR with output from the [omnieff](https://github.com/TeamMacLean/omnieff) effector prediction pipeline. A key focus is **identifying singleton effectors** - proteins unique to individual isolates that may drive host specificity or represent recently evolved virulence factors.

## Setup and Data Loading

```{r setup, message=FALSE}
library(paneffectR)
library(dplyr)
library(ggplot2)
```

For this vignette, we use pre-computed clustering results with synthetic data that simulates typical effector analysis:

```{r load-data}
visual_dir <- system.file("testdata", "visual", package = "paneffectR")
clusters <- readRDS(file.path(visual_dir, "clusters_visual.rds"))
proteins <- readRDS(file.path(visual_dir, "proteins_visual.rds"))

clusters
proteins
```

## Finding Unique Effectors: Singletons

When comparing effector repertoires across pathogen isolates, **singletons are often the most biologically interesting proteins**. These are proteins that couldn't be clustered with any protein from other assemblies - they appear to be unique to a single isolate.

Singletons are important because they may represent:

- **Recently evolved effectors** - Novel proteins that emerged in a specific lineage
- **Candidate avirulence genes** - Effectors recognized by host resistance proteins, driving isolate-specific incompatibility
- **Host adaptation factors** - Proteins that enable colonization of specific host genotypes
- **Candidates for functional characterization** - High-priority targets for understanding what makes isolates different

### Extracting Singletons

paneffectR provides dedicated functions for working with singletons:

```{r get-singletons}
# Get all singletons
singletons <- get_singletons(clusters)
singletons

# Count singletons
n_singletons(clusters)

# Summary by assembly
singletons_by_assembly(clusters, proteins)
```

### Singleton Scores: Are They Real Effectors?

A key question is whether singletons are genuine effector candidates or just annotation artifacts. We can examine their prediction scores to assess confidence:

```{r singleton-scores}
# Get all proteins with scores
all_proteins <- do.call(rbind, lapply(names(proteins$assemblies), function(asm) {
  proteins$assemblies[[asm]]$proteins %>%
    mutate(assembly = asm)
}))

# Join singletons with their scores
singleton_scores <- singletons %>%
  left_join(
    all_proteins %>% select(protein_id, custom_score),
    by = "protein_id"
  ) %>%
  arrange(desc(custom_score))

singleton_scores
```

Several singletons have high effector prediction scores (>6), suggesting they are genuine effector candidates worthy of follow-up, not just noise in the data.

### Visualizing Singleton Score Distribution

How do singleton scores compare to proteins in orthogroups?

```{r singleton-score-distribution, fig.height=4}
# Add clustering status to all proteins
clustered_proteins <- clusters$orthogroups %>%
  select(protein_id) %>%
  mutate(status = "In orthogroup")

singleton_status <- singletons %>%
  select(protein_id) %>%
  mutate(status = "Singleton")

protein_status <- bind_rows(clustered_proteins, singleton_status)

# Join with scores
score_comparison <- all_proteins %>%
  inner_join(protein_status, by = "protein_id")

# Plot comparison
ggplot(score_comparison, aes(x = custom_score, fill = status)) +
geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("In orthogroup" = "steelblue", "Singleton" = "coral")) +
  labs(
    title = "Effector Score Distribution: Singletons vs Orthogroup Members",
    x = "Effector Prediction Score",
    y = "Density",
    fill = "Clustering Status"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

This shows that singletons span the full range of effector scores - some are high-confidence effector candidates, while others may be lower-priority.

### Exporting Singletons for Follow-up

Export high-scoring singletons for experimental validation:

```{r export-singletons, eval=FALSE}
# High-confidence singleton effectors
high_score_singletons <- singleton_scores %>%
  filter(custom_score >= 5.0)

write.csv(high_score_singletons, "high_confidence_singletons.csv", row.names = FALSE)
```

## Pan-Effectorome Structure

Beyond singletons, it's useful to see the overall structure of the effector pan-genome. paneffectR provides functions to visualize how proteins are distributed across assemblies.

### Visualizing Pan-Effectorome Structure

```{r pan-effectorome-bar, fig.height=4}
plot_pan_structure(clusters)
```

This shows the composition of the pan-effectorome:

- **Core**: Present in all assemblies - likely essential for pathogenicity
- **Accessory**: Present in many but not all assemblies
- **Rare**: Present in few assemblies (default: ≤10% of assemblies)
- **Unique**: Orthogroups with members from only 1 assembly
- **Singleton**: Proteins that couldn't be clustered at all - truly unique

The thresholds for Rare and Accessory categories are configurable:

```{r pan-structure-custom, eval=FALSE}
# Custom thresholds: Rare if in ≤20% of assemblies, Accessory if ≤50%
plot_pan_structure(clusters, rare_threshold = 0.20, accessory_threshold = 0.50)
```

### Per-Assembly Breakdown

How does each assembly contribute to the pan-effectorome?

```{r per-assembly-breakdown, fig.height=5}
plot_assembly_composition(clusters)
```

Use `position = "fill"` to show proportions instead of counts:

```{r per-assembly-proportions, fig.height=5}
plot_assembly_composition(clusters, position = "fill")
```

## Working with Effector Scores

### Score-Based Filtering

When building matrices, you can filter to high-confidence effectors:

```{r filtered-matrix}
# Build unfiltered matrix first
pa <- build_pa_matrix(clusters, type = "binary")

# Build matrix with score threshold
# Only orthogroups containing proteins with score >= 5 are included
pa_filtered <- build_pa_matrix(
  clusters,
  type = "binary",
  score_threshold = 5.0,
  proteins = proteins
)

cat("All orthogroups:", nrow(pa$matrix), "\n")
cat("After score filter (>=5):", nrow(pa_filtered$matrix), "\n")
```

### Score-Based Matrix

Instead of binary presence/absence, create a matrix with actual scores:

```{r score-matrix}
pa_score <- build_pa_matrix(
  clusters,
  type = "score",
  score_column = "custom_score",
  proteins = proteins
)

# View scores (0 = absent, otherwise the score value)
pa_score$matrix[1:5, ]
```

## Visualizing Effector Repertoires

### Heatmap

```{r heatmap, fig.height=6}
ht <- plot_heatmap(
  pa,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_row_names = FALSE,
  color = c("white", "darkred")
)
ComplexHeatmap::draw(ht)
```

### UpSet Plot

Which effector combinations are most common?

```{r upset}
plot_upset(pa, min_size = 1)
```

### Assembly Dendrogram

How similar are effector repertoires between assemblies?

```{r dendro}
plot_dendro(pa, distance_method = "jaccard")
```

## Exporting Results

### Export Matrices

```{r export-matrix, eval=FALSE}
# Export presence/absence matrix
write.csv(as.data.frame(pa), "effector_presence_absence.csv")

# Export orthogroup membership
write.csv(clusters$orthogroups, "orthogroup_membership.csv", row_names = FALSE)
```

### Export Singletons

```{r export-all-singletons, eval=FALSE}
# All singletons with scores
write.csv(singleton_scores, "all_singletons_with_scores.csv", row.names = FALSE)

# Summary by assembly
write.csv(
  singletons_by_assembly(clusters, proteins),
  "singletons_summary.csv",
  row.names = FALSE
)
```

## Summary

Key steps for effector analysis with paneffectR:

1. **Load data** with `load_proteins(fasta_dir, score_dir)`
2. **Cluster** with `cluster_proteins()` (requires DIAMOND)
3. **Examine singletons first** - use `get_singletons()` and check their scores
4. **Build matrices** with `build_pa_matrix()`, optionally filtering by score
5. **Visualize** with `plot_heatmap()`, `plot_upset()`, `plot_dendro()`
6. **Export** singletons and orthogroup membership for follow-up

## Next Steps

- **[Getting Started](getting-started.html)** - Basic workflow overview
- **[Pan-Genome Analysis](pan-genome.html)** - Analysis without scores
- **[Algorithm Deep Dive](algorithms.html)** - Technical details on clustering
